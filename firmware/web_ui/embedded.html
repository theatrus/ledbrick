<!-- LEDBrick Embedded Controls for ESPHome Web Server -->
<!-- Add this to your ESPHome web interface for quick controls -->

<div class="ledbrick-controls">
    <h3>🎨 Quick Presets</h3>
    <div class="ledbrick-button-group">
        <button class="ledbrick-button" onclick="loadLEDBrickPreset('dynamic_sunrise_sunset')">🌅 Dynamic Sunrise</button>
        <button class="ledbrick-button" onclick="loadLEDBrickPreset('full_spectrum')">☀️ Full Spectrum</button>
        <button class="ledbrick-button" onclick="loadLEDBrickPreset('simple')">💡 Simple</button>
        <button class="ledbrick-button" onclick="loadLEDBrickPreset('moonlight_only')">🌙 Moonlight</button>
    </div>
</div>

<div class="ledbrick-controls">
    <h3>🔆 Brightness Control</h3>
    <input type="range" class="ledbrick-slider" id="ledBrickPWM" min="0" max="100" value="100" 
           oninput="setLEDBrickPWM(this.value)">
    <div style="text-align: center; margin-top: 10px;">
        <span id="ledBrickPWMValue">100%</span>
    </div>
    <div class="ledbrick-button-group" style="margin-top: 15px;">
        <button class="ledbrick-button" onclick="setLEDBrickPWM(100)">100%</button>
        <button class="ledbrick-button" onclick="setLEDBrickPWM(75)">75%</button>
        <button class="ledbrick-button" onclick="setLEDBrickPWM(50)">50%</button>
        <button class="ledbrick-button" onclick="setLEDBrickPWM(30)">30%</button>
        <button class="ledbrick-button" onclick="setLEDBrickPWM(0)">OFF</button>
    </div>
</div>

<div class="ledbrick-controls">
    <h3>📅 Schedule Management</h3>
    <div class="ledbrick-button-group">
        <button class="ledbrick-button" onclick="toggleLEDBrickScheduler()">⏯️ Toggle Scheduler</button>
        <button class="ledbrick-button" onclick="clearLEDBrickSchedule()">🗑️ Clear Schedule</button>
        <button class="ledbrick-button" onclick="saveLEDBrickToFlash()">💾 Save to Flash</button>
    </div>
    
    <div class="ledbrick-json-container">
        <h4>Import/Export Schedule JSON</h4>
        <textarea id="ledBrickJSON" class="ledbrick-json-textarea" placeholder="Paste schedule JSON here..."></textarea>
        <div class="ledbrick-button-group" style="margin-top: 10px;">
            <button class="ledbrick-button" onclick="exportLEDBrickSchedule()">📤 Export</button>
            <button class="ledbrick-button" onclick="importLEDBrickSchedule()">📥 Import</button>
        </div>
    </div>
</div>

<script>
// LEDBrick Embedded Control Functions

async function ledBrickRequest(path, method = 'GET', body = null) {
    const options = { method };
    if (body && method === 'POST') {
        const params = new URLSearchParams();
        for (const key in body) {
            params.append(key, body[key]);
        }
        options.body = params;
        options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
    }
    
    try {
        const response = await fetch(path, options);
        return await response.text();
    } catch (error) {
        console.error('LEDBrick request failed:', error);
        throw error;
    }
}

async function loadLEDBrickPreset(preset) {
    try {
        await ledBrickRequest('/select/preset_selector/set', 'POST', { option: preset });
        showLEDBrickStatus('Preset loaded: ' + preset);
    } catch (error) {
        showLEDBrickStatus('Failed to load preset', 'error');
    }
}

async function setLEDBrickPWM(value) {
    try {
        await ledBrickRequest('/number/pwm_scale/set', 'POST', { value: value });
        document.getElementById('ledBrickPWM').value = value;
        document.getElementById('ledBrickPWMValue').textContent = value + '%';
        showLEDBrickStatus('Brightness: ' + value + '%');
    } catch (error) {
        showLEDBrickStatus('Failed to set brightness', 'error');
    }
}

async function toggleLEDBrickScheduler() {
    try {
        const response = await ledBrickRequest('/switch/web_scheduler_enable');
        const data = JSON.parse(response);
        const action = data.state === 'ON' ? 'turn_off' : 'turn_on';
        await ledBrickRequest(`/switch/web_scheduler_enable/${action}`, 'POST');
        showLEDBrickStatus('Scheduler ' + (data.state === 'ON' ? 'disabled' : 'enabled'));
    } catch (error) {
        showLEDBrickStatus('Failed to toggle scheduler', 'error');
    }
}

async function clearLEDBrickSchedule() {
    if (confirm('Clear all schedule points?')) {
        try {
            await ledBrickRequest('/button/clear_schedule_button/press', 'POST');
            showLEDBrickStatus('Schedule cleared');
        } catch (error) {
            showLEDBrickStatus('Failed to clear schedule', 'error');
        }
    }
}

async function saveLEDBrickToFlash() {
    try {
        await ledBrickRequest('/button/save_to_flash_button/press', 'POST');
        showLEDBrickStatus('Saved to flash');
    } catch (error) {
        showLEDBrickStatus('Failed to save', 'error');
    }
}

async function exportLEDBrickSchedule() {
    try {
        await ledBrickRequest('/button/export_schedule_json_button/press', 'POST');
        await new Promise(resolve => setTimeout(resolve, 500));
        const response = await ledBrickRequest('/text_sensor/schedule_json_export');
        const data = JSON.parse(response);
        document.getElementById('ledBrickJSON').value = data.state;
        showLEDBrickStatus('Schedule exported');
    } catch (error) {
        showLEDBrickStatus('Export failed', 'error');
    }
}

async function importLEDBrickSchedule() {
    const json = document.getElementById('ledBrickJSON').value.trim();
    if (!json) {
        showLEDBrickStatus('No JSON data', 'error');
        return;
    }
    
    try {
        JSON.parse(json); // Validate
        await ledBrickRequest('/text/schedule_json_import/set', 'POST', { value: json });
        await ledBrickRequest('/button/import_schedule_json_button/press', 'POST');
        showLEDBrickStatus('Schedule imported');
    } catch (error) {
        showLEDBrickStatus('Import failed', 'error');
    }
}

function showLEDBrickStatus(message, type = 'success') {
    const el = document.createElement('div');
    el.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#ff6b6b' : '#51cf66'};
        color: white;
        border-radius: 4px;
        z-index: 9999;
        transition: opacity 0.3s;
    `;
    el.textContent = message;
    document.body.appendChild(el);
    
    setTimeout(() => {
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 300);
    }, 3000);
}

// Initialize PWM slider
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await ledBrickRequest('/number/pwm_scale');
        const data = JSON.parse(response);
        document.getElementById('ledBrickPWM').value = data.value;
        document.getElementById('ledBrickPWMValue').textContent = data.value + '%';
    } catch (error) {
        console.error('Failed to get initial PWM value');
    }
});
</script>